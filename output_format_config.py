
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
æ ‡å‡†åŒ–è¾“å‡ºæ ¼å¼é…ç½®
è§£å†³é—®é¢˜4-8ï¼šè·¨é›†è¿è´¯æ€§ã€å›ºå®šè¾“å‡ºæ ¼å¼ã€å†…å®¹äº®ç‚¹ã€é”™åˆ«å­—ä¿®æ­£ç­‰
"""

class OutputFormatConfig:
    """æ ‡å‡†åŒ–è¾“å‡ºæ ¼å¼é…ç½®ç±»"""
    
    # æ ‡å‡†æ–‡ä»¶å‘½åæ ¼å¼
    FILE_NAMING = {
        'episode_report': 'E{episode_num}_å®Œæ•´å‰§æƒ…åˆ†ææŠ¥å‘Š.txt',
        'segment_analysis': 'E{episode_num}_{title}_åˆ†ææŠ¥å‘Š.txt',
        'video_clip': 'E{episode_num}_{title}.mp4',
        'subtitle_file': 'E{episode_num}_{title}_æ—ç™½.srt',
        'series_summary': 'å…¨å‰§å‰§æƒ…è¿è´¯æ€§åˆ†æ.txt'
    }
    
    # é”™åˆ«å­—ä¿®æ­£è¯å…¸ (é—®é¢˜7)
    TYPO_CORRECTIONS = {
        # ç¹ä½“å­—ä¿®æ­£
        'é˜²è¡›': 'é˜²å«', 'æ­£ç•¶': 'æ­£å½“', 'è¨¼æ“š': 'è¯æ®', 'æª¢å¯Ÿå®˜': 'æ£€å¯Ÿå®˜',
        'å¯©åˆ¤': 'å®¡åˆ¤', 'è¾¯è­·': 'è¾©æŠ¤', 'èµ·è¨´': 'èµ·è¯‰', 'èª¿æŸ¥': 'è°ƒæŸ¥',
        'ç™¼ç¾': 'å‘ç°', 'æ±ºå®š': 'å†³å®š', 'é¸æ“‡': 'é€‰æ‹©', 'é–‹å§‹': 'å¼€å§‹',
        'çµæŸ': 'ç»“æŸ', 'å•é¡Œ': 'é—®é¢˜', 'æ©Ÿæœƒ': 'æœºä¼š', 'è¨­è¨ˆ': 'è®¾è®¡',
        
        # æ—¥æ–‡æ±‰å­—ä¿®æ­£
        'æ¤œå¯Ÿå®˜': 'æ£€å¯Ÿå®˜', 'æ¤œæŸ¥': 'æ£€æŸ¥', 'è¨¼äºº': 'è¯äºº',
        'å®Ÿç¾': 'å®ç°', 'å®Ÿéš›': 'å®é™…', 'å®Ÿè¨¼': 'å®è¯',
        'å¯¾è©±': 'å¯¹è¯', 'å¯¾å¿œ': 'å¯¹åº”', 'å¯¾è±¡': 'å¯¹è±¡',
        'é–¢ä¿‚': 'å…³ç³»', 'é–¢é€£': 'å…³è”', 'é–¢å¿ƒ': 'å…³å¿ƒ',
        
        # å¸¸è§æ‰“å­—é”™è¯¯
        'è¯å‰§': 'è¯æ®', 'å‘çº¿': 'å‘ç°', 'å†³è®¢': 'å†³å®š',
        'é€‰æ³½': 'é€‰æ‹©', 'è°ƒå‰': 'è°ƒæŸ¥', 'å®¡åˆ¤': 'å®¡åˆ¤'
    }
    
    # æ ‡å‡†æŠ¥å‘Šæ¨¡æ¿ (é—®é¢˜5)
    REPORT_TEMPLATE = """ğŸ“º ç¬¬{episode_num}é›† å®Œæ•´å‰§æƒ…åˆ†ææŠ¥å‘Š
{"=" * 100}

ğŸ“Š åŸºæœ¬ä¿¡æ¯:
â€¢ é›†æ•°: ç¬¬{episode_num}é›†
â€¢ æ–‡ä»¶: {source_file}
â€¢ å‰§æƒ…ç‚¹æ•°é‡: {segment_count} ä¸ª
â€¢ æˆåŠŸç‰‡æ®µ: {clip_count} ä¸ª
â€¢ æ€»æ—¶é•¿: {total_duration} ç§’ ({duration_minutes} åˆ†é’Ÿ)

ğŸ¯ ä¸»çº¿å‰§æƒ…:
{main_storyline}

ğŸ”— è·¨é›†è¿è´¯æ€§åˆ†æ:
ã€ä¸å‰é›†è¡”æ¥ã€‘: {prev_connection}
ã€ä¸ºä¸‹é›†é“ºå«ã€‘: {next_setup}

âœ¨ å†…å®¹äº®ç‚¹æ€»è§ˆ:
{content_highlights}

ğŸ­ å‰§æƒ…ç‚¹è¯¦ç»†åˆ†æ:
{detailed_segments}

{"=" * 100}
ğŸ“‹ æ ‡å‡†åŒ–è¾“å‡ºæ ¼å¼æ€»ç»“:
{"=" * 100}

ğŸ¬ åˆ¶ä½œè§„æ ¼:
â€¢ å‰§æƒ…ç‚¹æ™ºèƒ½è¯†åˆ«: 5ç§ç±»å‹è‡ªåŠ¨åˆ†ç±»
â€¢ ç‰‡æ®µæ—¶é•¿æ§åˆ¶: æ¯ä¸ªç‰‡æ®µ2-3åˆ†é’Ÿ
â€¢ éè¿ç»­åˆå¹¶: æ”¯æŒè·³è·ƒå¼æ—¶é—´æ®µæ™ºèƒ½æ‹¼æ¥
â€¢ é”™åˆ«å­—ä¿®æ­£: è‡ªåŠ¨ä¿®æ­£å¸¸è§ç¹ä½“å­—å’Œé”™è¯¯
â€¢ æ—ç™½ç”Ÿæˆ: ä¸“ä¸šæ—è§‚è€…å™è¿°ï¼Œè¯¦ç»†æ¸…æ™°

ğŸ”— è¿è´¯æ€§ä¿è¯:
â€¢ é›†å†…è¿è´¯: æ‰€æœ‰ç‰‡æ®µç»„åˆå®Œæ•´è®²è¿°æœ¬é›†æ•…äº‹
â€¢ è·¨é›†è¡”æ¥: æ˜ç¡®æ ‡æ³¨ä¸å‰åé›†çš„å…³è”ç‚¹
â€¢ ä¸»çº¿è¿½è¸ª: é‡ç‚¹è¿½è¸ªæ ¸å¿ƒæ¡ˆä»¶å‘å±•è„‰ç»œ

âœ¨ è´¨é‡æ ‡å‡†:
â€¢ æˆå‰§å¼ åŠ›: æ¯ä¸ªç‰‡æ®µéƒ½æœ‰å†²çªæˆ–è½¬æŠ˜ç‚¹
â€¢ è§‚çœ‹ä½“éªŒ: é€‚åˆçŸ­è§†é¢‘å¹³å°ä¼ æ’­
â€¢ æ•…äº‹å®Œæ•´: æ¯ä¸ªç‰‡æ®µéƒ½æœ‰èµ·æ‰¿è½¬åˆ
â€¢ ä¿¡æ¯å‡†ç¡®: å­—å¹•é”™è¯¯å·²ä¿®æ­£ï¼Œä¾¿äºå‰ªè¾‘å‚è€ƒ

ç”Ÿæˆæ—¶é—´: {generation_time}
ç³»ç»Ÿç‰ˆæœ¬: æ™ºèƒ½å‰§æƒ…ç‚¹å‰ªè¾‘ç³»ç»Ÿ v3.0
"""
    
    # ç‰‡æ®µåˆ†ææ¨¡æ¿
    SEGMENT_TEMPLATE = """
{"=" * 60}
ç‰‡æ®µ{segment_num}: {title}
{"=" * 60}
ğŸ­ ç±»å‹: {plot_type}
ğŸ“Š è¯„åˆ†: {score}/100
â±ï¸ æ—¶é—´: {start_time} --> {end_time} ({duration}ç§’)
ğŸ’¡ æ„ä¹‰: {plot_significance}

ğŸ™ï¸ æ—è§‚è€…å™è¿°:
{narration}

ğŸ“ å…³é”®å°è¯ (å·²ä¿®æ­£é”™åˆ«å­—):
{key_dialogues}

âœ¨ æœ¬ç‰‡æ®µäº®ç‚¹:
{highlights}

ğŸ”— è¿è´¯æ€§åˆ†æ:
{continuity_analysis}

ğŸ“„ å†…å®¹æ‘˜è¦: {content_summary}
"""
    
    # è·¨é›†è¿è´¯æ€§åˆ†æè§„åˆ™ (é—®é¢˜4)
    CONTINUITY_RULES = {
        'previous_connection_keywords': {
            'ç»§ç»­': "æ‰¿æ¥å‰é›†æœªå®Œæˆçš„æƒ…èŠ‚çº¿ï¼Œæ•…äº‹è¿ç»­å‘å±•",
            'å›åˆ°': "å›é¡¾å‰é›†å…³é”®äº‹ä»¶ï¼Œä¸ºæœ¬é›†å‘å±•åšé“ºå«",
            'å›æƒ³': "å›é¡¾å‰é›†å…³é”®äº‹ä»¶ï¼Œä¸ºæœ¬é›†å‘å±•åšé“ºå«",
            'ç”³è¯‰': "åœ¨å‰é›†åŸºç¡€ä¸Šå¯åŠ¨ç”³è¯‰ç¨‹åº",
            'å¬è¯ä¼š': "å‰é›†ç”³è¯‰å‡†å¤‡å®Œæ¯•ï¼Œæœ¬é›†è¿›å…¥å¬è¯é˜¶æ®µ"
        },
        
        'next_setup_keywords': {
            'ç»§ç»­': "æœ¬é›†æƒ…èŠ‚æœªå®Œï¼Œä¸‹é›†å°†ç»§ç»­å‘å±•",
            'å¾…ç»­': "æœ¬é›†æƒ…èŠ‚æœªå®Œï¼Œä¸‹é›†å°†ç»§ç»­å‘å±•",
            'ç”³è¯‰': "ç”³è¯‰å‡†å¤‡å·¥ä½œå®Œæˆï¼Œä¸‹é›†å¬è¯ä¼šå³å°†å¼€å§‹",
            'å¬è¯ä¼š': "å¬è¯ä¼šå‡†å¤‡å°±ç»ªï¼Œä¸‹é›†æ³•åº­æ¿€è¾©å³å°†å±•å¼€",
            'è¯æ®': "æ–°è¯æ®æµ®ç°ï¼Œä¸‹é›†æ¡ˆä»¶å°†è¿æ¥é‡å¤§è½¬æŠ˜",
            'çœŸç›¸': "çœŸç›¸å³å°†å¤§ç™½ï¼Œä¸‹é›†å°†æœ‰é‡å¤§æ­éœ²"
        }
    }
    
    # å†…å®¹äº®ç‚¹æå–è§„åˆ™ (é—®é¢˜6)
    HIGHLIGHT_RULES = {
        'å…³é”®å†²çª': [
            "æ¿€çƒˆå†²çªåœºé¢ï¼Œæˆå‰§å¼ åŠ›å¼ºçƒˆ",
            "æ ¸å¿ƒäº‰è®®ç„¦ç‚¹ï¼Œè§‚ç‚¹é’ˆé”‹ç›¸å¯¹",
            "æƒ…ç»ªå¯¹æŠ—æ¿€çƒˆï¼Œå†²çªå‡çº§æ˜æ˜¾"
        ],
        'çº¿ç´¢æ­éœ²': [
            "å…³é”®çº¿ç´¢é¦–æ¬¡æŠ«éœ²ï¼Œæ¨è¿›ä¸»çº¿å‰§æƒ…",
            "é‡è¦è¯æ®æ›å…‰ï¼Œæ¡ˆä»¶è¿æ¥è½¬æŠ˜",
            "çœŸç›¸é€æ­¥æµ®ç°ï¼Œæ‚¬å¿µé€æ­¥è§£å¼€"
        ],
        'äººç‰©è½¬æŠ˜': [
            "è§’è‰²é‡è¦è½¬æŠ˜æ—¶åˆ»ï¼Œäººç‰©å‘å±•å…³é”®èŠ‚ç‚¹",
            "å†…å¿ƒæŒ£æ‰æ¸…æ™°å±•ç°ï¼Œè§’è‰²æ·±åº¦åˆ»ç”»",
            "å‘½è¿è½¬æŠ˜ç‚¹ï¼Œåç»­å‘å±•å…³é”®"
        ],
        'æƒ…æ„Ÿçˆ†å‘': [
            "æƒ…æ„Ÿé«˜æ½®æ—¶åˆ»ï¼Œæ„ŸæŸ“åŠ›å¼º",
            "å†…å¿ƒæƒ…ç»ªå½»åº•é‡Šæ”¾ï¼ŒçœŸæƒ…æµéœ²",
            "æ„Ÿäººè‡³æ·±çš„æƒ…æ„Ÿè¡¨è¾¾"
        ],
        'é‡è¦å¯¹è¯': [
            "å…³é”®ä¿¡æ¯äº¤æµï¼Œæ¨è¿›å‰§æƒ…å‘å±•",
            "é‡è¦å†³ç­–è®¨è®ºï¼Œå½±å“åç»­èµ°å‘",
            "æ·±åº¦å¯¹è¯å±•ç°è§’è‰²å…³ç³»"
        ]
    }
    
    # ä¸»çº¿å‰§æƒ…è¯†åˆ«å…³é”®è¯
    MAIN_STORYLINE_KEYWORDS = {
        'å››äºŒå…«æ¡ˆ': "å››äºŒå…«æ¡ˆè°ƒæŸ¥è¿›å±•",
        '628æ¡ˆ': "628æ—§æ¡ˆé‡æ–°å®¡è§†", 
        '628æ—§æ¡ˆ': "628æ—§æ¡ˆé‡æ–°å®¡è§†",
        'ç”³è¯‰': "ç”³è¯‰ç¨‹åºå¯åŠ¨",
        'å¬è¯ä¼š': "å¬è¯ä¼šæ¿€è¾©",
        'å¼ å›­': "å¼ å›­éœ¸å‡Œäº‹ä»¶çœŸç›¸",
        'æ®µæ´ªå±±': "æ®µæ´ªå±±çˆ¶å¥³æƒ…æ·±",
        'éœ¸å‡Œ': "æ ¡å›­éœ¸å‡Œäº‹ä»¶è°ƒæŸ¥",
        'æ­£å½“é˜²å«': "æ­£å½“é˜²å«äº‰è®®æ ¸å¿ƒ"
    }
    
    @staticmethod
    def correct_typos(text: str) -> str:
        """ä¿®æ­£æ–‡æœ¬ä¸­çš„é”™åˆ«å­—"""
        corrected = text
        for old, new in OutputFormatConfig.TYPO_CORRECTIONS.items():
            corrected = corrected.replace(old, new)
        return corrected
    
    @staticmethod
    def generate_episode_filename(episode_num: str, file_type: str, title: str = "") -> str:
        """ç”Ÿæˆæ ‡å‡†åŒ–æ–‡ä»¶å"""
        template = OutputFormatConfig.FILE_NAMING.get(file_type, "E{episode_num}_{title}.txt")
        safe_title = title.replace(" ", "_").replace("ï¼š", "_") if title else "default"
        return template.format(episode_num=episode_num, title=safe_title)
    
    @staticmethod
    def extract_highlights(plot_type: str, content: str, score: float) -> list:
        """æå–å†…å®¹äº®ç‚¹"""
        highlights = []
        
        # åŸºäºå‰§æƒ…ç‚¹ç±»å‹çš„äº®ç‚¹
        type_highlights = OutputFormatConfig.HIGHLIGHT_RULES.get(plot_type, [])
        if type_highlights:
            highlights.extend(type_highlights)
        
        # åŸºäºè¯„åˆ†çš„äº®ç‚¹
        if score >= 80:
            highlights.append("æ ¸å¿ƒå‰§æƒ…ç‰‡æ®µï¼Œè§‚çœ‹ä»·å€¼æé«˜")
        elif score >= 60:
            highlights.append("é‡è¦å‰§æƒ…èŠ‚ç‚¹ï¼Œå€¼å¾—é‡ç‚¹å…³æ³¨")
        
        # åŸºäºå†…å®¹çš„å…·ä½“äº®ç‚¹
        if 'çœŸç›¸' in content or 'å‘ç°' in content:
            highlights.append("çœŸç›¸æ­éœ²æ—¶åˆ»ï¼Œæƒ…èŠ‚åè½¬ç²¾å½©")
        if 'è¯æ®' in content:
            highlights.append("å…³é”®è¯æ®å±•ç¤ºï¼Œæ¡ˆä»¶è¿›å±•é‡è¦")
        if 'å†³å®š' in content or 'é€‰æ‹©' in content:
            highlights.append("å…³é”®å†³ç­–æ—¶åˆ»ï¼Œå½±å“åç»­å‘å±•")
        
        return highlights
    
    @staticmethod
    def analyze_continuity(content: str, plot_type: str, position: str) -> str:
        """åˆ†æè·¨é›†è¿è´¯æ€§"""
        continuity_points = []
        
        rules = OutputFormatConfig.CONTINUITY_RULES
        
        if position == "previous":
            for keyword, description in rules['previous_connection_keywords'].items():
                if keyword in content:
                    continuity_points.append(description)
        elif position == "next":
            for keyword, description in rules['next_setup_keywords'].items():
                if keyword in content:
                    continuity_points.append(description)
        
        # åŸºäºå‰§æƒ…ç‚¹ç±»å‹çš„è¿è´¯æ€§åˆ†æ
        if plot_type == 'çº¿ç´¢æ­éœ²':
            if position == "next":
                continuity_points.append("å…³é”®çº¿ç´¢å·²ç»æŠ«éœ²ï¼Œä¸‹é›†å°†æ·±å…¥è¿½æŸ¥")
        elif plot_type == 'å…³é”®å†²çª':
            if position == "next":
                continuity_points.append("å†²çªå·²ç»çˆ†å‘ï¼Œä¸‹é›†å°†é¢ä¸´æ›´å¤§æŒ‘æˆ˜")
        
        return "ï¼›".join(continuity_points) if continuity_points else "ä¿æŒå‰§æƒ…é€»è¾‘è¿è´¯æ€§"
